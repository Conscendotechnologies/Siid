name: Build and Release Alpexium IDE (SemVer)
on:
  push:
    branches:
      - main-stable
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (auto/major/minor/patch)'
        required: false
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
        default: 'auto'
      prerelease:
        description: 'Mark as pre-release/preview'
        required: false
        type: boolean
        default: false

jobs:
  version-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15.1'
          cache: 'npm'
          
      - name: Get latest tag
        id: get_latest_tag
        shell: bash
        run: |
          # Get the latest tag with 'v' prefix, sorted semantically
          LATEST_TAG=$(git tag -l "v*.*.*" --sort=-version:refname | head -n 1)
          
          # If no tags found, default to v1.105.1
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v1.105.1"
            echo "No tags found, using default: $LATEST_TAG"
          else
            # Extract version without 'v' prefix
            VERSION=${LATEST_TAG#v}
            
            # Split version into components
            IFS='.' read -r PART1 PART2 PART3 <<< "$VERSION"
            
            # Check if this is the old YYYY.MAJOR.MINOR format
            # Old format: year >= 2000 (e.g., 2025.0.0)
            # New format: MAJOR < 2000 (e.g., 1.105.1)
            if [ "$PART1" -ge 2000 ]; then
              echo "âš ï¸  Detected old version format: $LATEST_TAG (YYYY.MAJOR.MINOR)"
              echo "ðŸ”„ Resetting to semantic versioning: v1.105.1"
              LATEST_TAG="v1.105.1"
            else
              echo "âœ… Using existing semantic version: $LATEST_TAG"
            fi
          fi
          
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"
          
          # Extract version numbers (remove 'v' prefix)
          VERSION=${LATEST_TAG#v}
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          
      - name: Analyze commits for version bump
        id: analyze_commits
        shell: bash
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
          
          # Get commits since last tag
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            COMMITS=$(git log $LATEST_TAG..HEAD --pretty=format:"%s" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"%s" --no-merges | head -20)
          fi
          
          echo "Analyzing commits:"
          echo "$COMMITS"
          
          # Determine bump type based on conventional commits
          BUMP_TYPE="patch"
          
          # Check for breaking changes (MAJOR)
          if echo "$COMMITS" | grep -qiE "^(BREAKING CHANGE:|feat!:|fix!:|refactor!:)"; then
            BUMP_TYPE="major"
            echo "ðŸ”´ BREAKING CHANGE detected â†’ MAJOR version bump"
          # Check for new features (MINOR)
          elif echo "$COMMITS" | grep -qiE "^feat(\(.*\))?:"; then
            BUMP_TYPE="minor"
            echo "ðŸŸ¡ New feature detected â†’ MINOR version bump"
          # Check for fixes or other changes (PATCH)
          elif echo "$COMMITS" | grep -qiE "^(fix|perf|refactor|docs|chore|style|test)(\(.*\))?:"; then
            BUMP_TYPE="patch"
            echo "ðŸŸ¢ Fix/improvement detected â†’ PATCH version bump"
          else
            BUMP_TYPE="patch"
            echo "âšª No conventional commits â†’ default PATCH version bump"
          fi
          
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          
      - name: Calculate new version
        id: calc_version
        shell: bash
        run: |
          CURRENT_VERSION="${{ steps.get_latest_tag.outputs.current_version }}"
          BUMP_TYPE="${{ github.event.inputs.version_bump || steps.analyze_commits.outputs.bump_type }}"
          
          echo "Current version: $CURRENT_VERSION"
          echo "Bump type: $BUMP_TYPE"
          
          # Parse current version (format: MAJOR.MINOR.PATCH)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          # Apply semantic version bump
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              echo "ðŸ”´ MAJOR bump: $CURRENT_VERSION â†’ $MAJOR.$MINOR.$PATCH"
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              echo "ðŸŸ¡ MINOR bump: $CURRENT_VERSION â†’ $MAJOR.$MINOR.$PATCH"
              ;;
            patch|auto)
              PATCH=$((PATCH + 1))
              echo "ðŸŸ¢ PATCH bump: $CURRENT_VERSION â†’ $MAJOR.$MINOR.$PATCH"
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
          
      - name: Check if version already exists
        id: check_version
        shell: bash
        run: |
          NEW_TAG="${{ steps.calc_version.outputs.new_tag }}"
          
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "âš ï¸  Tag $NEW_TAG already exists!"
            echo "version_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tag $NEW_TAG is available"
            echo "version_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Install dependencies
        if: steps.check_version.outputs.version_exists == 'false'
        run: npm install
        
      - name: Compile Extensions
        if: steps.check_version.outputs.version_exists == 'false'
        run: npm run gulp -- compile-extensions
        
      - name: Build Windows x64 min
        if: steps.check_version.outputs.version_exists == 'false'
        run: npm run gulp -- vscode-win32-x64-min
        
      - name: Build Inno Updater
        if: steps.check_version.outputs.version_exists == 'false'
        run: npm run gulp -- vscode-win32-x64-inno-updater
        
      - name: Build User Setup
        if: steps.check_version.outputs.version_exists == 'false'
        run: npm run gulp -- vscode-win32-x64-user-setup
        
      - name: Build System Setup
        if: steps.check_version.outputs.version_exists == 'false'
        run: npm run gulp -- vscode-win32-x64-system-setup
        
      - name: Rename and collect setup files
        if: steps.check_version.outputs.version_exists == 'false'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ./release-output
          
          $userSetupPath = ".build/win32-x64/user-setup/SIIDSetup.exe"
          if (Test-Path $userSetupPath) {
            Copy-Item $userSetupPath -Destination "./release-output/AlpexiumIDE-v${{ steps.calc_version.outputs.new_version }}-UserSetup.exe"
            Write-Host "âœ“ User Setup copied and renamed"
          } else {
            Write-Error "User Setup not found at $userSetupPath"
            exit 1
          }
          
          $systemSetupPath = ".build/win32-x64/system-setup/SIIDSetup.exe"
          if (Test-Path $systemSetupPath) {
            Copy-Item $systemSetupPath -Destination "./release-output/AlpexiumIDE-v${{ steps.calc_version.outputs.new_version }}-SystemSetup.exe"
            Write-Host "âœ“ System Setup copied and renamed"
          } else {
            Write-Error "System Setup not found at $systemSetupPath"
            exit 1
          }
          
      - name: Generate checksums
        if: steps.check_version.outputs.version_exists == 'false'
        shell: pwsh
        run: |
          cd release-output
          Get-ChildItem -Filter "*.exe" | ForEach-Object {
            $hash = (Get-FileHash -Algorithm SHA256 $_.Name).Hash
            $hash | Out-File -FilePath "$($_.Name).sha256" -NoNewline
            Write-Host "âœ“ Checksum for $($_.Name): $hash"
          }
          
      - name: Get build timestamp
        id: timestamp
        shell: bash
        run: |
          echo "build_date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "build_date_compact=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          
      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
          
          # Get commits since last tag
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            echo "Generating changelog from $LATEST_TAG to HEAD"
            COMMITS=$(git log $LATEST_TAG..HEAD --pretty=format:"- %s by @%an in %h" --no-merges)
          else
            echo "No previous release found. Generating changelog from all commits."
            COMMITS=$(git log --pretty=format:"- %s by @%an in %h" --no-merges | head -20)
          fi
          
          # Check if there are any commits
          if [ -z "$COMMITS" ]; then
            COMMITS="- No changes since last release"
          fi
          
          # Save to file
          echo "$COMMITS" > changelog.txt
          
          # Read into output
          CHANGELOG=$(cat changelog.txt)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Get contributors
        id: contributors
        shell: bash
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
          
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            CONTRIBUTORS=$(git log $LATEST_TAG..HEAD --pretty=format:"%an" --no-merges | sort -u | sed 's/^/@/' | paste -sd "," - | sed 's/,/, /g')
          else
            CONTRIBUTORS=$(git log --pretty=format:"%an" --no-merges | sort -u | head -10 | sed 's/^/@/' | paste -sd "," - | sed 's/,/, /g')
          fi
          
          if [ -z "$CONTRIBUTORS" ]; then
            CONTRIBUTORS="@${{ github.actor }}"
          fi
          
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT
          
      - name: Create Release
        if: steps.check_version.outputs.version_exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          name: "Alpexium IDE v${{ steps.calc_version.outputs.new_version }}"
          tag_name: ${{ steps.calc_version.outputs.new_tag }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || 'false' }}
          generate_release_notes: false
          body: |
            ## Alpexium IDE Installers
            
            **Build Date:** ${{ steps.timestamp.outputs.build_date }}
            **Version:** v${{ steps.calc_version.outputs.new_version }}
            **Version Bump:** ${{ steps.analyze_commits.outputs.bump_type }}
            
            ---
            
            ### ðŸ“¦ Downloads
            
            | Installer | Description |
            |-----------|-------------|
            | **AlpexiumIDE-v${{ steps.calc_version.outputs.new_version }}-UserSetup.exe** | User installation (current user only, no admin required) |
            | **AlpexiumIDE-v${{ steps.calc_version.outputs.new_version }}-SystemSetup.exe** | System installation (all users, requires administrator) |
            
            ### ðŸ” Checksums
            Use the .sha256 files to verify your download integrity.
            
            ---
            
            ### ðŸ“ What's Changed
            
            ${{ steps.changelog.outputs.changelog }}
            
            **Full Changelog:** ${{ github.server_url }}/${{ github.repository }}/compare/${{ steps.get_latest_tag.outputs.latest_tag }}...${{ steps.calc_version.outputs.new_tag }}
            
            ---
            
            ### ðŸ‘¥ Contributors
            
            ${{ steps.contributors.outputs.contributors }}
            
            ---
            
            ### ðŸ“‹ Version Information
            
            Alpexium IDE follows **Semantic Versioning**: `MAJOR.MINOR.PATCH`
            - **MAJOR**: Breaking changes or significant new features
            - **MINOR**: New features (backward compatible)
            - **PATCH**: Bug fixes and minor improvements
          files: |
            release-output/*.exe
            release-output/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload Build Artifacts
        if: steps.check_version.outputs.version_exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: alpexium-ide-installers-v${{ steps.calc_version.outputs.new_version }}
          path: |
            release-output/*.exe
            release-output/*.sha256
          retention-days: 90
          
      - name: Summary
        if: always()
        shell: bash
        run: |
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Version | \`${{ steps.get_latest_tag.outputs.latest_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| New Version | \`${{ steps.calc_version.outputs.new_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump Type | **${{ steps.analyze_commits.outputs.bump_type }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Date | ${{ steps.timestamp.outputs.build_date }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Exists | ${{ steps.check_version.outputs.version_exists }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prerelease | ${{ github.event.inputs.prerelease || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_version.outputs.version_exists }}" == "true" ]; then
            echo "### âš ï¸ Warning" >> $GITHUB_STEP_SUMMARY
            echo "Version ${{ steps.calc_version.outputs.new_tag }} already exists. Build was skipped." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "Release ${{ steps.calc_version.outputs.new_tag }} created successfully!" >> $GITHUB_STEP_SUMMARY
          fi
